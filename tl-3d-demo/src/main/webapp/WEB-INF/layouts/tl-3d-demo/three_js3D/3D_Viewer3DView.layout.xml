<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	template="tl-3d-threejs/threejs.template.xml"
>
	<arguments
		model="model(tl-3d-demo/three_js3D/sceneGrid.layout.xml#Grid)"
		multiSelection="true"
		selection="selection(tl-3d-demo/three_js3D/sceneGrid.layout.xml#Grid)"
	>
		<name key="dynamic.2affe21a-3127-4135-b45a-c6e45b0e3dbf">
			<de>3D-Viewer</de>
		</name>
		<modelBuilder class="com.top_logic.threed.threejs.component.SceneBuilderByExpression"
			resolveParts="node -> $node.get(`tl.threed.demo:Assembly#children`)"
			rootNode="scene -> $scene.get(`tl.threed.demo:Scene#root`)"
			supportsModel="model -> $model.instanceOf(`tl.threed.demo:Scene`)"
			supportsObject="node -> $node.instanceOf(`tl.threed.demo:Node`)"
			typesToObserve="tl.threed.demo:Node"
		>
			<createNode><![CDATA[node -> switch {
  $node.instanceOf(`tl.threed.demo:Part`) || $node.get(`tl.threed.demo:Node#asset`) != null: 
    threejsGltf(
      tx:  $node.get(`tl.threed.demo:Node#tx`),
      userData: $node,
      url: $node.get(`tl.threed.demo:Part#asset`).get(`tl.threed.demo:Asset3D#gltfUrl`));
  $node.instanceOf(`tl.threed.demo:Assembly`):
    threejsGroup(
      tx: $node.get(`tl.threed.demo:Node#tx`),
      userData: $node);
}]]></createNode>
		</modelBuilder>
		<applyScript><![CDATA[changedNodes -> model -> {
  $changedNodes.foreach(node -> {
    newTransformation = $node.threejsAccess("transform");
    $node.threejsAccess("userData").set(`tl.threed.demo:Node#tx`, transform($newTransformation[0],$newTransformation[1],$newTransformation[2],$newTransformation[3],$newTransformation[4],$newTransformation[5],$newTransformation[6],$newTransformation[7],$newTransformation[8],$newTransformation[9],$newTransformation[10],$newTransformation[11]));
  });
}]]></applyScript>
		<buttons>
			<button id="ID_4893bf3f_116f_421c_b560_842f9b4b1073"
				class="com.top_logic.layout.form.component.InvalidateCommand"
			/>
		</buttons>
	</arguments>
</config:template-call>